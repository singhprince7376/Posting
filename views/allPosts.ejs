<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Posts</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="/stylesheet/styles.css">
  <style>
    body {
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      color: #f1f1f1;
      font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 40px auto;
    }

    .post {
      background: rgba(44, 47, 51, 0.98);
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.18);
      animation: fadeInUp 0.8s;
      transition: box-shadow 0.3s, transform 0.3s;
      color: #f1f1f1;
      border: none !important;
    }

    .post:hover {
      box-shadow: 0 6px 24px #4db8ff33;
      transform: translateY(-2px) scale(1.01);
    }

    .profile-header img {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 2px solid #4db8ff;
      object-fit: cover;
      box-shadow: 0 2px 8px #222;
      margin-right: 16px;
      transition: transform 0.3s;
    }

    .profile-header img:hover {
      transform: scale(1.08) rotate(-2deg);
    }

    .profile-header h3 {
      color: #4db8ff;
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .post-title {
      color: #ffb84d;
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 6px;
      margin-top: 10px;
    }

    .post-content {
      color: #eaeaea;
      margin-bottom: 10px;
    }

    .btn,
    .btn-outline-danger,
    .btn-outline-info,
    .btn-outline-secondary,
    .btn-outline-primary {
      border-radius: 8px !important;
      font-weight: 600;
      transition: background 0.3s, transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px #222;
    }

    .btn-outline-danger:hover,
    .btn-outline-info:hover,
    .btn-outline-secondary:hover,
    .btn-outline-primary:hover,
    .btn:hover {
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 4px 16px #4db8ff55;
    }

    .comment {
      background: rgba(34, 36, 38, 0.98);
      color: #f1f1f1;
      border-radius: 8px;
      box-shadow: 0 1px 6px #222;
      animation: fadeIn 0.7s;
      border: none !important;
    }

    .comment strong {
      color: #4db8ff;
    }

    .comment small {
      color: #aaa;
    }

    .no-posts {
      color: #aaa;
      text-align: center;
      font-size: 1.2rem;
      margin-top: 40px;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    a {
      color: #4db8ff;
      text-decoration: none;
      font-weight: 600;
    }

    a:hover {
      text-decoration: underline;
      color: #ffb84d;
    }

    .navbar,
    .navbar-dark.bg-dark {
      background: #232526 !important;
      border-bottom: 2px solid #4db8ff;
    }

    .navbar-brand {
      color: #4db8ff !important;
      font-weight: 700;
      font-size: 1.3rem;
    }

    .nav-link {
      color: #f1f1f1 !important;
      font-weight: 600;
      transition: color 0.2s;
    }

    .nav-link:hover {
      color: #ffb84d !important;
    }

    .input-group input,
    .form-control {
      background: #23272a !important;
      color: #f1f1f1 !important;
      border: 1px solid #333 !important;
    }

    .input-group input:focus,
    .form-control:focus {
      border-color: #4db8ff !important;
      box-shadow: 0 0 8px #4db8ff44 !important;
    }

    .btn-outline-primary {
      border-color: #4db8ff !important;
      color: #4db8ff !important;
      background: transparent !important;
    }

    .btn-outline-primary:hover {
      background: #4db8ff !important;
      color: #232526 !important;
    }

    .btn-outline-danger {
      border-color: #ff4d4d !important;
      color: #ff4d4d !important;
      background: transparent !important;
    }

    .btn-outline-danger:hover {
      background: #ff4d4d !important;
      color: #fff !important;
    }

    .btn-outline-info {
      border-color: #4db8ff !important;
      color: #4db8ff !important;
      background: transparent !important;
    }

    .btn-outline-info:hover {
      background: #4db8ff !important;
      color: #232526 !important;
    }

    .btn-outline-secondary {
      border-color: #aaa !important;
      color: #aaa !important;
      background: transparent !important;
    }

    .btn-outline-secondary:hover {
      background: #aaa !important;
      color: #232526 !important;
    }

    @media (max-width: 900px) {
      .container {
        padding: 18px;
      }

      .post {
        padding: 12px;
      }
    }

    .profile-pic {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 2px solid #4db8ff;
      object-fit: cover;
      box-shadow: 0 2px 8px #222;
      transition: transform 0.3s;
    }

    .profile-pic:hover {
      transform: scale(1.08) rotate(-2deg);
    }
  </style>
</head>

<body>

  <%- include('partials/navbar') %>

  <main>
    <div class="container mt-4">
      <% if (posts.length===0) { %>
        <p class="no-posts">No posts available.</p>
      <% } else { %>
        <% posts.forEach((post)=> { %>
          <div class="post mb-4 p-3">
            <!-- Profile Header with Picture & Name -->
            <div class="profile-header d-flex align-items-center mb-2">
              <% if (post.user) { %>
                <img src="<%= post.user.profilePic || 'default.png' %>" alt="Profile Picture"
                  class="profile-pic me-2" />
                <div>
                  <h3>
                    <% if (user && user._id.toString() === post.user._id.toString()) { %>
                      <a href="/profile"><%= post.user.name %></a>
                    <% } else { %>
                      <a href="/user/<%= post.user._id %>"><%= post.user.name %></a>
                    <% } %>
                  </h3>
                  <small>Posted on: <%= new Date(post.createdAt).toDateString() %></small>
                </div>
              <% } else { %>
                <img src="default.png" alt="Default Profile Picture" class="profile-pic me-2" />
                <div>
                  <h3>Unknown User</h3>
                  <small>Posted on: <%= new Date(post.createdAt).toDateString() %></small>
                </div>
              <% } %>
            </div>

            <!-- Post Title & Content -->
            <h4 class="post-title">
              <% if (user && user._id.toString() === post.user._id.toString()) { %>
                <a href="/profile"><%= post.title %></a>
              <% } else { %>
                <a href="/user/<%= post.user._id %>"><%= post.title %></a>
              <% } %>
            </h4>
            <p class="post-content">
              <%= post.content %>
            </p>
            <% if (post.image) { %>
              <img src="<%= post.image %>" alt="Post Image" style="max-width: 500px; height: auto; margin-top: 10px; border-radius: 8px; display: block;">
            <% } %>

            <% if (user) { %>
              <form action="/post/<%= post._id %>/like" method="POST" style="display:inline;">
                <button class="btn btn-sm btn-outline-danger" type="submit">
                  <%= post.likes.includes(user._id.toString()) ? 'Unlike' : 'Like' %> (<%= post.likes.length %>)
                </button>
              </form>
            <% } %>

            <!-- Comments Section -->
            <div class="comments mt-3">
              <button class="btn btn-sm btn-outline-info" onclick="toggleComments('<%= post._id %>')">Show Comments (<%= post.comments ? post.comments.length : 0 %>)</button>
              <div id="comments-<%= post._id %>" style="display: none;">
                <h6 style="color:#4db8ff;">Comments:</h6>
                <% if (post.comments && post.comments.length > 0) { %>
                  <% post.comments.slice(0, 3).forEach((comment) => { %>
                    <div class="comment mb-2 p-2 d-flex justify-content-between align-items-start">
                      <div>
                        <strong><%= comment.user && comment.user.name ? comment.user.name : 'Unknown' %></strong>: <%= comment.content %>
                        <small class="text-muted"> - <%= new Date(comment.createdAt).toLocaleString() %></small>
                        <br>
                        <small class="text-muted"><%= comment.likes.length %> likes</small>
                      </div>
                      <div>
                        <% if (user) { %>
                          <form action="/post/<%= post._id %>/comment/<%= comment._id %>/like" method="POST" style="display:inline;">
                            <button class="btn btn-sm btn-outline-danger" type="submit">
                              <%= comment.likes.includes(user._id.toString()) ? 'Unlike' : 'Like' %> (<%= comment.likes.length %>)
                            </button>
                          </form>
                          <% if (post.user._id.toString() === user._id.toString() || comment.user._id.toString() === user._id.toString()) { %>
                            <form action="/post/<%= post._id %>/comment/<%= comment._id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Delete this comment?')">
                              <button class="btn btn-sm btn-outline-secondary" type="submit">Delete</button>
                            </form>
                          <% } %>
                        <% } %>
                      </div>
                    </div>
                  <% }) %>
                  <% if (post.comments.length > 3) { %>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadMoreComments('<%= post._id %>')">Load More</button>
                    <div id="more-comments-<%= post._id %>" style="display: none;">
                      <% post.comments.slice(3).forEach((comment) => { %>
                        <div class="comment mb-2 p-2 d-flex justify-content-between align-items-start">
                          <div>
                            <strong><%= comment.user && comment.user.name ? comment.user.name : 'Unknown' %></strong>: <%= comment.content %>
                            <small class="text-muted"> - <%= new Date(comment.createdAt).toLocaleString() %></small>
                            <br>
                            <small class="text-muted"><%= comment.likes.length %> likes</small>
                          </div>
                          <div>
                            <% if (user) { %>
                              <form action="/post/<%= post._id %>/comment/<%= comment._id %>/like" method="POST" style="display:inline;">
                                <button class="btn btn-sm btn-outline-danger" type="submit">
                                  <%= comment.likes.includes(user._id.toString()) ? 'Unlike' : 'Like' %> (<%= comment.likes.length %>)
                                </button>
                              </form>
                              <% if (post.user._id.toString() === user._id.toString() || comment.user._id.toString() === user._id.toString()) { %>
                                <form action="/post/<%= post._id %>/comment/<%= comment._id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Delete this comment?')">
                                  <button class="btn btn-sm btn-outline-secondary" type="submit">Delete</button>
                                </form>
                              <% } %>
                            <% } %>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  <% } %>
                <% } else { %>
                  <p class="text-muted">No comments yet.</p>
                <% } %>
                <!-- Add Comment Form -->
                <% if (user) { %>
                  <form action="/post/<%= post._id %>/comment" method="POST" class="mt-2">
                    <div class="input-group">
                      <input type="text" name="content" class="form-control" placeholder="Add a comment..." required>
                      <button class="btn btn-outline-primary" type="submit">Comment</button>
                    </div>
                  </form>
                <% } else { %>
                  <p class="text-muted"><a href="/login">Login to comment</a></p>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </main>

  <script>
    function toggleComments(postId) {
      const commentsDiv = document.getElementById(`comments-${postId}`);
      if (commentsDiv.style.display === 'none') {
        commentsDiv.style.display = 'block';
      } else {
        commentsDiv.style.display = 'none';
      }
    }

    function loadMoreComments(postId) {
      const moreDiv = document.getElementById(`more-comments-${postId}`);
      if (moreDiv.style.display === 'none') {
        moreDiv.style.display = 'block';
      } else {
        moreDiv.style.display = 'none';
      }
    }
  </script>
</body>

</html>
